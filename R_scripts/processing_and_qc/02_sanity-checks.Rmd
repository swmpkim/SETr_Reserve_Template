---
title: "SET Data Sanity Checks"
date: "`r Sys.Date()`"
output: word_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

Read in processed data (all SETs in same CSV file) and perform some basic checks of the parameters.  


```{r load_packages, echo = TRUE, message = FALSE, warning = FALSE}
library(knitr)
library(readr)
library(readxl)
library(janitor)
library(dplyr)
library(tidyr)
library(ggplot2)
library(here)
# library(flextable)
source(here::here('R_scripts', '000_functions.R'))
```


Read in data. Can see how it's formatted in the following output.  

```{r}
################################################################################
# get the data in
################################################################################

# find the folder with processed data
path <- here::here('data', 'processed')

# in that folder, find the name of the file(s) that ends with 'set.csv'
filelist <- grep('set_QC.csv$', dir(path), value = TRUE)



# generate warnings if the folder is empty; if there are multiple matching files, select the first one
if (length(filelist) == 0) stop("There are no files of the correct name/format (---set_QC.csv) in your processed data folder.")

if (length(filelist) > 1) {
    warning("There is more than one file of the correct format (---set_QC.csv) in your data folder. The first file alphabetically will be used.")
    filelist <- filelist[1]
}



# generate the full path to the file; read it in and get pin heights to mm
filename <- paste0(path, "/", filelist)
dat <- read_csv(filename)
dat <- height_to_mm(dat)



# if the date column is datetime, posixct, or posixlt, change it to Date
if (sum(class(dat$date) %in% c("datetime", "POSIXct", "POSIXlt")) > 0)
    dat$date <- as.Date(dat$date)
```


# Introduce some wonkiness for testing purposes  

```{r}

################## FOR TESTING ONLY ##########################
# make some wonky values
dat$flag[2:4] <- 2
##############################################################

############## for testing only ##########################
# make a negative pin height
dat$pin_height[2] <- -5
##########################################################
```

When QC flag is [one of a subset of numbers; i'll pick 2], make pin_height `NA` to exclude that value from analysis. Generate another tabular summary.

__NOTE__ At this point, I've inserted a few wonky values. A '2' flag in the 2nd-4th rows of the data frame, and a negative pin reading as the first pin_height. This is to test the script's capabilities to detect these.  

```{r}
# summarize original dataframe
overview <- dat %>%
    group_by(reserve, set_id, date) %>%
    summarize(pre_n = sum(!is.na(pin_height)),
              pre_min = min(pin_height, na.rm = TRUE),
              pre_max = max(pin_height, na.rm = TRUE)) %>%
    ungroup()

# back up original data frame  
dat_backup <- dat


# remove wonky values
dat$pin_height[dat$flag == '2'] <- NA

# overview after removing suspect data points
overview_trimmed <- dat %>%
    group_by(reserve, set_id, date) %>%
    summarize(post_n = sum(!is.na(pin_height)),
              post_min = min(pin_height, na.rm = TRUE),
              post_max = max(pin_height, na.rm = TRUE)) %>%
    ungroup()

# join them together
overview_all <- full_join(overview, overview_trimmed) %>%
        mutate(removed = pre_n - post_n)
```


play with flextable. Just kidding; this won't work without pandoc 2.0 or higher, and that's not yet bundled with RStudio. Keeping the code here because I think that will be supported soon, and then we can auto-highlight some of the output. 

```{r}
# overview_ft <- regulartable(head(overview_all))
# overview_ft <- color(overview_ft, i = ~ removed > 0,
#                      j = ~ date + removed,
#                      color = "red")
# overview_ft <- bg(overview_ft, i = ~ removed > 0,
#                      j = ~ date + removed,
#                      bg = "gray80")
# overview_ft
```


Print out some information about each SET.  

```{r, results = "asis", message = FALSE, warning = FALSE}

unique_sets <- unique(dat$set_id)

# thank you stackoverflow for helping with this format
# https://stackoverflow.com/questions/36373630/how-to-create-a-loop-that-includes-both-a-code-chunk-and-text-with-knitr-in-r

for(i in seq_along(unique_sets)){
    cat("  \n###", unique_sets[i], "  \n")
    
    # subset the data and remove columns we don't need
    overview_sub <- overview_all[overview_all$set_id == unique_sets[i], ]
    
    num_dates <- length(unique(overview_sub$date, na.rm = TRUE))
    first_date <- min(unique(overview_sub$date, na.rm = TRUE))
    last_date <- max(unique(overview_sub$date, na.rm = TRUE))
    
    readings_summ <- data.frame("times_read" = num_dates,
                                "first_reading" = first_date,
                                "last_reading" = last_date)
    
    print(kable(readings_summ, 
                align = "c",
                caption = "Summary of SET visits"))
    
    cat("  \n")
    cat("  \n")
    
    # select only wonky data points
    overview_sub <- overview_sub %>%
        filter(pre_n != 36 | post_n != 36 | removed != 0) %>%
        select(-reserve, -set_id)
    
    # print the subsetted data
    if(nrow(overview_sub) > 0){
    print(kable(overview_sub, 
                align = "c",
                caption = "Summary of reading dates that do not meet QC criteria"))
    } else {print("All reading dates meet QC criteria (36 pins; no readings removed by QC codes)")}
    
    cat("  \n")
    
}
```


# Tests to perform  

Find any counts that are not 36  
Especially find any that are > 36  
Find differences between pre- and post- QC point removal



# Tests and Checks  

## Negative Pin Heights  

```{r}
# check for negative pin heights

if(sum(dat$pin_height < 0, na.rm = TRUE) >= 1) {
    print(paste0("There are ", sum(dat$pin_height < 0, na.rm = TRUE), " pin heights <0. They are listed below."))
    neg_pin_hts <- dat %>% filter(pin_height < 0)
    kable(neg_pin_hts)
    } else {print("all pin heights are >0")}
```